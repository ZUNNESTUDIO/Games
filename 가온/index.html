using UnityEngine;
using UnityEngine.AI;

public class AllInOneGame : MonoBehaviour { }

//////////////////////
// GAME MANAGER
//////////////////////
public class GM : MonoBehaviour
{
    public static GM I;
    public int kills;
    public int puzzleScore;

    void Awake() => I = this;

    public void AddKill() { kills++; Debug.Log("Kills : " + kills); }
    public void AddPuzzle(int s) { puzzleScore += s; Debug.Log("Puzzle Score : " + puzzleScore); }
}

//////////////////////
// PLAYER HEALTH
//////////////////////
public class PlayerHP : MonoBehaviour
{
    public int hp = 100;

    public void Hit(int dmg)
    {
        hp -= dmg;
        if (hp <= 0) Debug.Log("PLAYER DEAD");
    }
}

//////////////////////
// PLAYER MOVEMENT
//////////////////////
public class PlayerMove : MonoBehaviour
{
    public float speed = 5;
    public float jump = 2.5f;
    public float crouchH = 1f;

    CharacterController cc;
    float oriH;
    Vector3 vel;

    void Start()
    {
        cc = GetComponent<CharacterController>();
        oriH = cc.height;
    }

    void Update()
    {
        float x = Input.GetAxis("Horizontal");
        float z = Input.GetAxis("Vertical");
        Vector3 mv = transform.right * x + transform.forward * z;

        cc.Move(mv * speed * Time.deltaTime);

        if (cc.isGrounded)
        {
            vel.y = -2;
            if (Input.GetKeyDown(KeyCode.Space))
                vel.y = Mathf.Sqrt(jump * -2 * Physics.gravity.y);
        }

        if (Input.GetKeyDown(KeyCode.F)) cc.height = crouchH;
        if (Input.GetKeyUp(KeyCode.F)) cc.height = oriH;

        vel.y += Physics.gravity.y * Time.deltaTime;
        cc.Move(vel * Time.deltaTime);
    }
}

//////////////////////
// PLAYER LOOK
//////////////////////
public class PlayerLook : MonoBehaviour
{
    public float sens = 150;
    public Transform body;
    float xRot;

    void Update()
    {
        float mx = Input.GetAxis("Mouse X") * sens * Time.deltaTime;
        float my = Input.GetAxis("Mouse Y") * sens * Time.deltaTime;

        xRot -= my;
        xRot = Mathf.Clamp(xRot, -80, 80);

        transform.localRotation = Quaternion.Euler(xRot, 0, 0);
        body.Rotate(Vector3.up * mx);
    }
}

//////////////////////
// WEAPON BASE
//////////////////////
public class Weapon : MonoBehaviour
{
    public string name;
    public int dmg;
    public float rate;
    public float range;

    public virtual void Shoot() { }
}

//////////////////////
// GUN
//////////////////////
public class Gun : Weapon
{
    public Camera cam;
    public ParticleSystem fx;
    float nextF;

    public override void Shoot()
    {
        if (Time.time < nextF) return;
        nextF = Time.time + 1f / rate;

        fx?.Play();

        if (Physics.Raycast(cam.transform.position, cam.transform.forward, out RaycastHit hit, range))
        {
            if (hit.collider.TryGetComponent(out EnemyAI e))
                e.Hit(dmg);
        }
    }
}

//////////////////////
// WEAPON CONTROLLER (20개 지원)
//////////////////////
public class WeaponCtrl : MonoBehaviour
{
    public Weapon[] w;
    int cur;

    void Start() => Select(0);

    void Update()
    {
        if (Input.GetAxis("Mouse ScrollWheel") > 0) Next();
        else if (Input.GetAxis("Mouse ScrollWheel") < 0) Prev();

        if (Input.GetMouseButton(0))
            w[cur].Shoot();

        // ADS
        Camera.main.fieldOfView = Input.GetMouseButton(1) ? 45 : 60;
    }

    void Next() { cur = (cur + 1) % w.Length; Select(cur); }
    void Prev() { cur = (cur - 1 + w.Length) % w.Length; Select(cur); }

    void Select(int i)
    {
        for (int x = 0; x < w.Length; x++)
            w[x].gameObject.SetActive(x == i);
    }
}

//////////////////////
// AI (Enemy)
//////////////////////
public class EnemyAI : MonoBehaviour
{
    public int hp = 100;
    public NavMeshAgent agent;
    public Transform target;
    public int dmg = 10;
    public float distShoot = 15;
    float nextS;

    void Update()
    {
        if (!target) return;

        agent.SetDestination(target.position);

        float d = Vector3.Distance(transform.position, target.position);

        if (d < distShoot && Time.time > nextS)
        {
            nextS = Time.time + 1;
            target.GetComponent<PlayerHP>()?.Hit(dmg);
        }
    }

    public void Hit(int d)
    {
        hp -= d;
        if (hp <= 0)
        {
            GM.I.AddKill();
            Destroy(gameObject);
        }
    }
}

//////////////////////
// AI (Friendly)
//////////////////////
public class FriendlyAI : MonoBehaviour
{
    public NavMeshAgent agent;
    public Transform enemy;

    void Update()
    {
        if (enemy)
            agent.SetDestination(enemy.position);
    }
}

//////////////////////
// PUZZLE OBJECT
//////////////////////
public class PuzzleObj : MonoBehaviour
{
    public bool solved;

    public void Solve()
    {
        if (solved) return;
        solved = true;

        GM.I.AddPuzzle(10);
        gameObject.SetActive(false);
    }
}

//////////////////////
// PUZZLE MANAGER
//////////////////////
public class PuzzleMgr : MonoBehaviour
{
    public static PuzzleMgr I;
    public int score;

    void Awake() => I = this;

    public void Add(int s)
    {
        score += s;
        Debug.Log("Puzzle Score: " + score);
    }
}

//////////////////////
// PLAYER SKIN SYSTEM
//////////////////////
public class SkinCtrl : MonoBehaviour
{
    public Renderer body;
    public Material[] skins;
    int idx;

    public void Next()
    {
        idx = (idx + 1) % skins.Length;
        body.material = skins[idx];
    }
}

//////////////////////
// GUN STATS DATABASE (20종)
//////////////////////
[System.Serializable]
public class WData
{
    public string n;
    public int d;
    public float r;
    public float rng;

    public WData(string a, int b, float c, float d2)
    {
        n = a; d = b; r = c; rng = d2;
    }
}

public static class WDB
{
    public static WData[] data =
    {
        new("Pistol",15,4.5f,35),
        new("Heavy Pistol",25,3,40),
        new("SMG",10,12,30),
        new("Uzi",12,14,25),
        new("AR",18,9,60),
        new("Burst AR",22,4,65),
        new("AK",25,7,70),
        new("Marksman",35,2,90),
        new("Sniper",80,0.8f,150),
        new("Silent Sniper",70,1,120),
        new("Shotgun",8,1.2f,20),
        new("Super Shotgun",12,0.8f,18),
        new("LMG",16,11,60),
        new("Heavy LMG",20,9,70),
        new("RPG",120,0.4f,80),
        new("Grenade Launcher",90,0.8f,50),
        new("Flamethrower",8,20,10),
        new("Laser Rifle",20,13,100),
        new("Burst Laser",30,4,90),
        new("Railgun",100,1,200)
    };
}
